<!-- <div class="d-flex gap-2 mb-2 align-items-center flex-wrap"> -->
<div class="row">
    <div class="col-4 flex-column">
        <div class="mb-3 mt-2">
            <button  class="btn btn-primary boton-alta me-2" type="button" id="" (click)="modalAltaOp()">
                Alta de Operacion
            </button>            
            <app-btn-editar name="cargaMultiple" class="" (click)="modalCargaMultiple()"  ></app-btn-editar>
        </div>
        <div class="d-flex align-items-end">            
            <!-- busqueda general -->
            <input
                  class="form-control align-self-end"  style="max-width:200px" placeholder="Buscar..."
                  [(ngModel)]="filtros.textoGlobal"
                  (input)="aplicarFiltros()"
                  />

              <!-- filtro clientes -->

              <select class="form-select align-self-end" style="width:150px"
                      [(ngModel)]="filtros.clienteId"
                      (change)="seleccionarCliente($any($event.target).value ? +$any($event.target).value : null)">
                  <option [ngValue]="null">Cliente</option>
                  @for (c of clientesDropdown; track c.id) {
                      <option [value]="c.id">{{c.n}}</option>
                  }
              </select>

              <!-- filtro choferes -->

              <select class="form-select align-self-end" style="width:150px"
                      [(ngModel)]="filtros.choferId"
                      (change)="seleccionarChofer($any($event.target).value ? +$any($event.target).value : null)">
                  <option [ngValue]="null">Chofer</option>
                  @for (c of choferesDropdown; track c.id) {
                      <option [value]="c.id">{{c.n}}</option>
                  }
              </select>

        </div>
    </div>
    <div class="col-4 d-flex justify-content-center">
        <div class="align-self-end">
            <div style="width:420px" class="">
                <app-tablero-fechas defaultTipo="semana"></app-tablero-fechas>  
            </div>    
        </div>      
    </div>
    <div class="col-4 flex-column">
        <div class="d-flex justify-content-end mb-3 mt-2">
            <button  class="btn btn-primary boton-alta" type="button" id="" (click)="descargarOp()">
                Descargar Op
            </button>
        </div>
        <div class="d-flex justify-content-end">
            <!-- limpiar filtros -->
            <div class="d-flex">
                <button class="btn btn-outline-secondary"
                        (click)="limpiarFiltrosTotales()">
                    Limpiar
                </button>
            </div>

            <!-- selector columnas -->
            <div class="d-flex">
                <div class="dropdown align-self-end" [class.show]="columnasDropdownOpen">
                    <button class="btn btn-outline-secondary dropdown-toggle"
                            (click)="toggleColumnasDropdown()">
                        Columnas
                    </button>

                    <div class="dropdown-menu p-2"
                        [class.show]="columnasDropdownOpen"
                        style="max-height:300px; overflow:auto">

                        @for (c of columnasDisponibles; track c) {
                            <div class="form-check">
                            <input class="form-check-input" type="checkbox"
                                    [checked]="isColVisible(c)"
                                    (change)="toggleCol(c)">
                            <label class="form-check-label">
                                {{ headerLabel(c) }}
                            </label>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
    


</div>

<div class="table-responsive" style="max-height:70vh; overflow:auto">

    <table class="table table-sm table-striped table-hover"
            style="table-layout: fixed;">

        <thead class="table-light" style="position:sticky; top:0; z-index:2">
            <tr>
                @for (c of columnasVisibles; track c) {

                    <th
                    (click)="sortBy(c)"
                    [ngStyle]="getColWidthStyle(c)"
                    class="th-resizable"
                    >

                        <div class="th-content">

                            <span class="th-label" type="button">
                            {{ headerLabel(c) }}

                            @if (filtros.sortCampo === c) {
                                <span class="sort-indicator">
                                {{ filtros.sortDir === 'asc' ? '▲' : '▼' }}
                                </span>
                            }
                            </span>

                            <!-- HANDLE SIEMPRE VISIBLE -->
                            <span
                            class="resize-handle"
                            (mousedown)="startResize($event, c)"
                            (click)="$event.stopPropagation()"
                            ></span>

                        </div>

                    </th>

                }

                <th style="width:135px">Acciones</th>
            </tr>

            <tr>
                @for (c of columnasVisibles; track c) {
                    <th>
                        <input
                            class="form-control"
                            [(ngModel)]="filtros.columnas[c]"
                            (input)="aplicarFiltros()"
                        />
                    </th>
                }
                <th></th>
            </tr>
        </thead>

        <tbody>
            @if(operacionesVista.length > 0){
                @for (row of operacionesVista; track row.idOperacion) {
                    <tr>
                        @for (c of columnasVisibles; track c) {
                            <td class="align-middle">
                                @if (c === 'estado') {
                                <span [class]="getEstadoBadgeClass(row.estado)">
                                    {{row.estado}}
                                </span>
                                } @else {
                                {{row[c]}}
                                }
                            </td>
                        }
                        <td class="text-nowrap align-middle">

                            <app-btn-leer
                                name="DetalleColor"
                                (click)="abrirModalDetalle(row.idOperacion, 'vista')">
                            </app-btn-leer>
                            
                            <app-btn-editar
                                [ngClass]="{'isDisabled':!puedeEditar(row)}"
                                name="EditarColor"
                                (click)="abrirModalDetalle(row.idOperacion, 'edicion')">
                            </app-btn-editar>
                            
                            
                            <app-btn-eliminar
                                name="EliminarColor"
                                [ngClass]="{'isDisabled':!puedeEliminar(row)}"
                                (click)="eliminar(row.idOperacion)">
                            </app-btn-eliminar>
                            
                            
                            <app-btn-agregar
                                name="FacturaColor" [ngClass]="{'isDisabled':!puedeCerrar(row)}"
                                (click)="abrirModalDetalle(row.idOperacion, 'cerrar')">
                            </app-btn-agregar>
                    
                        </td>
                    </tr>
                }
            } @else {
                <tr><td [colSpan]="columnasVisibles.length + 1" class="align-middle">Sin datos</td></tr>
            }

        </tbody>
    </table>

</div>

<div class="mt-2 text-muted small">
  Mostrando {{operacionesVista.length}} operaciones
</div>
@if (isLoading) {
    <app-spinner></app-spinner>
}
