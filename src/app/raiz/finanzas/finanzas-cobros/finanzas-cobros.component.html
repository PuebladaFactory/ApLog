<h2 class="mt-2">Registro de Cobros</h2>

<!-- Selección de cliente -->
<div class="row mb-3">
    <div class="col-6">
        <label>Cliente</label>                 
        <select
            class="form-select"
            [(ngModel)]="clienteSeleccionadoId"
            (change)="onClienteSeleccionado(clienteSeleccionadoId!)">

            <option [ngValue]="null">Seleccione un cliente</option>

            @for (cl of clientes; track cl.idCliente) {
            <option [value]="cl.idCliente">
                {{ cl.razonSocial }}
            </option>
            }
        </select>
    </div>
</div>

<!-- Spinner -->
@if (cargando) {
    <div class="text-center my-4">
      <app-spinner></app-spinner>
    </div>
}

<!-- Listado de informes pendientes -->
@if (!cargando && clienteSeleccionadoId) {

  @if (informesPendientes.length === 0) {
    <div class="alert alert-info">
      El cliente no tiene informes pendientes de cobro.
    </div>
  }

  @if (informesPendientes.length > 0) {

    <p class="mb-2">
      <strong>{{ informesPendientes.length }}</strong> informes pendientes
    </p>

    <table class="table table-hover table-sm align-middle">
      <thead class="table-light">
        <tr>
          <th></th>
          <th>N° Informe</th>
          <th>Fecha</th>
          <th>Entidad</th>
          <th>Mes</th>
          <th>Periodo Liq</th>
          <th>Estado</th>
          <th>Estado Financiero</th>
          <th class="text-end table-info" >Total</th>
          <th class="text-end table-success">Cobrado</th>
          <th class="text-end table-danger">Saldo</th>
        </tr>
      </thead>

      <tbody>
        @for (inf of informesPendientes; track inf.id) {
          <tr>
            <td class="text-center">
              <input
                type="checkbox"
                class="form-check-input"
                [checked]="estaSeleccionado(inf)"
                (change)="toggleSeleccion(inf, $any($event.target).checked)">
            </td>

            <td>{{ inf.numeroInterno }}</td>
            <td>{{ inf.fecha | date:'dd/MM/yyyy' }}</td>
            <td>{{ inf.entidad.razonSocial }}</td>
            <td>{{ inf.mes }}</td>
            <td>{{ inf.periodo }}</td>
            <td>{{ inf.estado }}</td>
            <td>{{ inf.estadoFinanciero }}</td>

            <td class="text-end table-info">
            {{ inf.valoresFinancieros.total | formatearValor :"$" }}
            </td>

            <td class="text-end table-success">
            {{ inf.valoresFinancieros.totalCobrado | formatearValor :"$" }}
            </td>

            <td class="text-end fw-bold table-danger">
            {{ inf.valoresFinancieros.saldo | formatearValor :"$" }}
            </td>
          </tr>
        }
      </tbody>
    </table>
  }
}

<!-- Resumen y acción -->
@if (informesSeleccionados.length > 0) {

  <div class="card mt-3">
    <div class="card-body d-flex justify-content-between align-items-center">

      <div>
        <div>
          <strong>Informes seleccionados:</strong>
          {{ informesSeleccionados.length }}
        </div>

        <div>
          <strong>Saldo total a cobrar:</strong>
          {{ totalSeleccionado | number:'1.2-2' }}
        </div>
      </div>

      <div>
        <button
          class="btn btn-success"
          [disabled]="!puedeRegistrarCobro()"
          (click)="registrarCobro()">
          Registrar cobro
        </button>
      </div>

    </div>
  </div>
}

